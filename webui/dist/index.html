<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Whisper Transcription - Usuário</title>
    <!-- Incluir CSS do Bootstrap ou do seu template aqui -->
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }

        .container {
            display: flex;
            height: 80vh;
        }

        .panel {
            flex: 1;
            padding: 20px;
            border: 1px solid #ccc;
            margin: 10px;
            overflow-y: auto;
        }

        #uploadStatus,
        #transcriptionList {
            margin-top: 10px;
        }

        .transcription-item {
            border-bottom: 1px solid #eee;
            padding: 10px 0;
        }

        .hidden {
            display: none;
        }

        .progress-bar {
            width: 100%;
            background-color: #f0f0f0;
            border-radius: 5px;
            overflow: hidden;
            margin-top: 5px;
        }

        .progress-fill {
            height: 20px;
            background-color: #4CAF50;
            width: 0%;
            transition: width 0.5s;
        }
    </style>
</head>

<body>
    <h1>Área do Usuário - Transcrição de Áudio</h1>

    <div class="container">
        <!-- Painel Esquerdo: Upload -->
        <div class="panel">
            <h2>Enviar Áudio</h2>
            <form id="uploadForm">
                <input type="file" id="audioFile" name="file" accept=".mp3,.wav" required>
                <button type="submit">Enviar</button>
            </form>
            <div id="uploadStatus"></div>
            <div id="progressContainer" class="hidden">
                <p>Enviando...</p>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
            </div>
        </div>

        <!-- Painel Direito: Transcrições -->
        <div class="panel">
            <h2>Minhas Transcrições</h2>
            <button id="refreshList">Atualizar Lista</button>
            <div id="transcriptionList">
                <!-- Lista de transcrições será carregada aqui -->
                <p>Carregando transcrições...</p>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = '/api'; // Base URL da API

        // --- Funções para o Painel Esquerdo (Upload) ---

        document.getElementById('uploadForm').addEventListener('submit', async function (e) {
            e.preventDefault();
            const fileInput = document.getElementById('audioFile');
            const file = fileInput.files[0];
            const statusDiv = document.getElementById('uploadStatus');
            const progressContainer = document.getElementById('progressContainer');
            const progressFill = document.getElementById('progressFill');

            if (!file) {
                statusDiv.innerHTML = '<p style="color: red;">Por favor, selecione um arquivo.</p>';
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            statusDiv.innerHTML = '';
            progressContainer.classList.remove('hidden');
            progressFill.style.width = '0%';

            try {
                const response = await fetch(`${API_BASE_URL}/upload`, {
                    method: 'POST',
                    body: formData,
                    // Adicionar progresso (opcional, mas bom para UX)
                    /*
                    onUploadProgress: function (progressEvent) {
                        if (progressEvent.lengthComputable) {
                            const percentCompleted = Math.round((progressEvent.loaded * 100) / progressEvent.total);
                            progressFill.style.width = percentCompleted + '%';
                        }
                    }
                    */
                });

                progressContainer.classList.add('hidden');

                if (response.ok) {
                    const data = await response.json();
                    statusDiv.innerHTML = `<p style="color: green;">Upload bem-sucedido: ${data.filename}</p>`;
                    fileInput.value = ''; // Limpar input
                    // Atualizar a lista de transcrições após upload
                    loadTranscriptions();
                } else {
                    const errorData = await response.json();
                    statusDiv.innerHTML = `<p style="color: red;">Erro no upload: ${errorData.detail || response.statusText}</p>`;
                }
            } catch (error) {
                progressContainer.classList.add('hidden');
                statusDiv.innerHTML = `<p style="color: red;">Erro de rede: ${error.message}</p>`;
            }
        });

        // --- Funções para o Painel Direito (Lista) ---

        async function loadTranscriptions() {
            const listDiv = document.getElementById('transcriptionList');
            listDiv.innerHTML = '<p>Carregando...</p>';

            try {
                const response = await fetch(`${API_BASE_URL}/transcriptions`);
                if (response.ok) {
                    const transcriptions = await response.json();
                    displayTranscriptions(transcriptions);
                } else {
                    listDiv.innerHTML = `<p style="color: red;">Erro ao carregar transcrições: ${response.statusText}</p>`;
                }
            } catch (error) {
                listDiv.innerHTML = `<p style="color: red;">Erro de rede: ${error.message}</p>`;
            }
        }

        function displayTranscriptions(transcriptions) {
            const listDiv = document.getElementById('transcriptionList');
            if (transcriptions.length === 0) {
                listDiv.innerHTML = '<p>Nenhuma transcrição encontrada.</p>';
                return;
            }

            let html = '<ul>';
            transcriptions.forEach(item => {
                // Simplificando o nome para exibição
                const displayName = item.name; // ou item.path.split('/').pop()
                html += `
                    <li class="transcription-item">
                        <strong>${displayName}</strong>
                        <br>Tamanho: ${(item.size / 1024).toFixed(2)} KB
                        <br>Modificado: ${new Date(item.modified).toLocaleString()}
                        <br><a href="${API_BASE_URL}/download/${encodeURIComponent(item.path)}" target="_blank">Baixar</a>
                        <!-- Adicionar status de processamento aqui se tiver -->
                    </li>
                `;
            });
            html += '</ul>';
            listDiv.innerHTML = html;
        }

        // --- Inicialização ---
        document.getElementById('refreshList').addEventListener('click', loadTranscriptions);

        // Carregar transcrições ao abrir a página
        document.addEventListener('DOMContentLoaded', function () {
            loadTranscriptions();
            // Opcional: Atualizar periodicamente
            // setInterval(loadTranscriptions, 30000); // A cada 30 segundos
        });

    </script>
</body>

</html>